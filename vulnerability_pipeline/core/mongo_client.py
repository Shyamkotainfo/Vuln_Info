from pymongo import MongoClient
from pymongo.errors import ConnectionFailure
import certifi
from .config import Config

class MongoManager:
    _client = None

    @classmethod
    def get_client(cls):
        if cls._client is None:
            try:
                uri = Config.MONGO_URI
                is_local = "localhost" in uri or "127.0.0.1" in uri
                
                if is_local:
                    print("⚠️ Localhost detected: Disabling TLS for MongoDB connection.")
                    cls._client = MongoClient(
                        uri,
                        serverSelectionTimeoutMS=20000,
                        appname="VulnerabilityPipeline"
                    )
                else:
                    cls._client = MongoClient(
                        uri,
                        tls=True,
                        tlsCAFile=certifi.where(),
                        serverSelectionTimeoutMS=20000,
                        appname="VulnerabilityPipeline"
                    )
                
                # verify connection
                cls._client.admin.command("ping")
                print("✅ Connected to MongoDB Atlas successfully.")
            except ConnectionFailure as e:
                print(f"❌ Could not connect to MongoDB Atlas: {e}")
                raise
        return cls._client

    @classmethod
    def get_db(cls, db_name):
        return cls.get_client()[db_name]

    @classmethod
    def get_bronze_db(cls):
        return cls.get_db(Config.DB_BRONZE)

    @classmethod
    def get_silver_db(cls):
        return cls.get_db(Config.DB_SILVER)

    @classmethod
    def get_gold_db(cls):
        return cls.get_db(Config.DB_GOLD)
