from vulnerability_pipeline.core.base_silver import BaseSilverPipeline
from datetime import datetime
import pymongo

class CISASilverPipeline(BaseSilverPipeline):
    def __init__(self):
        super().__init__(
            source_collection="cisa_raw",
            target_collection="cisa_silver",
            bronze_key="dateReleased", # or dateAdded? User said date_released is Partition Key
            silver_key="date_released"
        )

    def _ensure_indexes(self):
        self.target_col.create_index([("date_released", pymongo.ASCENDING)])
        self.target_col.create_index([("cve_id", pymongo.ASCENDING)], unique=True)

    def transform(self, doc):
        """
        Transforms CISA raw doc to Silver.
        Raw: {"cveID": "...", "dateReleased": "...", ...}
        """
        # 1. Basic Fields
        silver = {
            "_id": doc.get("cveID"),
            "cve_id": doc.get("cveID"),
            "title": "CISA Catalog of Known Exploited Vulnerabilities",
            
            # 2. Metadata
            "catalog_version": doc.get("catalogVersion"),
            "date_released": self._parse_iso(doc.get("dateReleased")),
            "count": doc.get("count"),
            
            # 3. Vulnerability Details
            "vendor_project": doc.get("vendorProject"),
            "product": doc.get("product"),
            "vulnerability_name": doc.get("vulnerabilityName"),
            "date_added": self._parse_date(doc.get("dateAdded")),
            "short_description": doc.get("shortDescription"),
            "required_action": doc.get("requiredAction"),
            "due_date": self._parse_date(doc.get("dueDate")),
            "known_ransomware_campaign_use": doc.get("knownRansomwareCampaignUse"),
            "notes": doc.get("notes"),
            "cwes": doc.get("cwes", [])
        }
        return silver

    def _parse_date(self, date_str):
        if not date_str: return None
        try:
            return datetime.strptime(date_str, "%Y-%m-%d")
        except: return None

    def _parse_iso(self, date_str):
        if not date_str: return None
        try:
            return datetime.fromisoformat(date_str.replace('Z', '+00:00'))
        except: return None
