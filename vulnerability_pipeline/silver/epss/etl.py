from vulnerability_pipeline.core.base_silver import BaseSilverPipeline
from datetime import datetime
import pymongo

class EPSSSilverPipeline(BaseSilverPipeline):
    def __init__(self):
        super().__init__(
            source_collection="epss_raw",
            target_collection="epss_silver",
            bronze_key="date", 
            silver_key="date"
        )

    def _ensure_indexes(self):
        self.target_col.create_index([("date", pymongo.ASCENDING)])
        self.target_col.create_index([("cve", pymongo.ASCENDING)], unique=True)

    def transform(self, doc):
        """
        Transforms EPSS raw doc to Silver.
        Raw: {"cve": "CVE...", "epss": "0.12", "percentile": "0.5", "date": "..."}
        """
        if not doc.get("cve"):
            return None
            
        silver = {
            "_id": doc.get("cve"),
            "cve": doc.get("cve"),
            "epss": float(doc.get("epss", 0.0)),
            "percentile": float(doc.get("percentile", 0.0)),
            "date": doc.get("date"), # Already YYYY-MM-DD from Bronze
            "data": doc.get("data") # Keep if exists, likely None
        }
        return silver
