from vulnerability_pipeline.core.base_silver import BaseSilverPipeline
from datetime import datetime
import pymongo

class MetasploitSilverPipeline(BaseSilverPipeline):
    def __init__(self):
        super().__init__(
            source_collection="metasploit_raw",
            target_collection="metasploit_silver",
            bronze_key="mod_time", 
            silver_key="mod_time"
        )

    def _ensure_indexes(self):
        self.target_col.create_index([("mod_time", pymongo.ASCENDING)])
        self.target_col.create_index([("fullname", pymongo.ASCENDING)], unique=True)

    def transform(self, doc):
        """
        Transforms Metasploit raw doc to Silver.
        """
        if not doc.get("fullname"):
            return None
            
        def safe_date(d):
            # Bronze has '2017-10-18 19:41:35 +0000' potentially?
            # Or simplified. We'll try to keep as ISO string or handle accordingly.
            return d

        silver = {
            "_id": doc.get("fullname"), # PK
            "fullname": doc.get("fullname"),
            "title": doc.get("title"),
            "name": doc.get("name"),
            "rank": doc.get("rank"),
            "disclosure_date": safe_date(doc.get("disclosure_date")),
            "mod_time": safe_date(doc.get("mod_time")),
            "type": doc.get("type"),
            "author": doc.get("author", []),
            "description": doc.get("description"),
            "references": doc.get("references", []),
            "platform": doc.get("platform"),
            "arch": doc.get("arch"),
            "rport": doc.get("rport"),
            "autofilter_ports": doc.get("autofilter_ports"),
            "autofilter_services": doc.get("autofilter_services"),
            "targets": doc.get("targets"),
            "path": doc.get("path"),
            "is_install_path": doc.get("is_install_path"),
            "ref_name": doc.get("ref_name"),
            "check": doc.get("check"),
            "post_auth": doc.get("post_auth"),
            "default_credential": doc.get("default_credential"),
            "notes": doc.get("notes"),
            "session_types": doc.get("session_types"),
            "needs_cleanup": doc.get("needs_cleanup"),
            "actions": doc.get("actions")
        }
        return silver
