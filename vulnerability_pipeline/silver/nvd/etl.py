from vulnerability_pipeline.core.base_silver import BaseSilverPipeline
from datetime import datetime
import pymongo

class NVDSilverPipeline(BaseSilverPipeline):
    def __init__(self):
        super().__init__(
            source_collection="nvd_raw",
            target_collection="nvd_silver",
            bronze_key="lastModified",
            silver_key="last_modified"
        )

    def _ensure_indexes(self):
        # Unique PK already covered by _id
        # Index on last_modified for efficient Watermark queries
        self.target_col.create_index([("last_modified", pymongo.ASCENDING)])
        self.target_col.create_index([("cve_id", pymongo.ASCENDING)], unique=True)

    def transform(self, doc):
        """
        Transforms NVD raw doc to Silver.
        Raw doc structure: {"_id": ObjectId, "id": "CVE-...", ... }
        """
        cve_data = doc
        if not cve_data or not cve_data.get("id"):
            return None

        # Helper for safer list access
        def safe_list(val):
            return val if isinstance(val, list) else []
            
        def safe_dict(val):
            return val if isinstance(val, dict) else {}

        # 1. Basic Fields
        silver = {
            "_id": cve_data.get("id"), # Use CVE ID as Mongo PK
            "cve_id": cve_data.get("id"),
            "source_identifier": cve_data.get("sourceIdentifier"),
            "vuln_status": cve_data.get("vulnStatus"),
            
            # 2. Key Dates (ISO -> Date)
            "published": self._parse_date(cve_data.get("published")),
            "last_modified": self._parse_date(cve_data.get("lastModified")),
            
            # 3. Lists
            "descriptions": [d.get("value") for d in safe_list(cve_data.get("descriptions")) if isinstance(d, dict) and d.get("lang") == "en"],
            "references": [r.get("url") for r in safe_list(cve_data.get("references")) if isinstance(r, dict)],
            "weaknesses": []
        }
        
        # Weaknesses
        weaknesses_list = safe_list(cve_data.get("weaknesses"))
        w_extracted = []
        for w in weaknesses_list:
            if isinstance(w, dict):
                descs = safe_list(w.get("description"))
                if descs and isinstance(descs[0], dict):
                     w_extracted.append(descs[0].get("value"))
        silver["weaknesses"] = w_extracted

        # 4. Metrics Flattening
        metrics = safe_dict(cve_data.get("metrics"))
        for metric_type, metric_list in metrics.items():
            if metric_list:
                new_key = f"metrics_{metric_type}"
                silver[new_key] = metric_list

        return silver

    def _parse_date(self, date_str):
        if not date_str:
            return None
        try:
            # Handle "2023-01-01T00:00:00.000" (sometimes has Z, sometimes doesn't)
            # NVD usually: 2019-06-17T17:15:00.000
            return datetime.fromisoformat(date_str.replace('Z', '+00:00'))
        except:
            return None
