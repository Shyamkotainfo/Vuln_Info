from vulnerability_pipeline.core.base_silver import BaseSilverPipeline
from datetime import datetime
import pymongo

class ExploitDBSilverPipeline(BaseSilverPipeline):
    def __init__(self):
        super().__init__(
            source_collection="exploitdb_raw",
            target_collection="exploit_silver",
            bronze_key="date_published", 
            silver_key="date_published"
        )

    def _ensure_indexes(self):
        self.target_col.create_index([("date_published", pymongo.ASCENDING)])
        self.target_col.create_index([("id", pymongo.ASCENDING)], unique=True)

    def transform(self, doc):
        """
        Transforms ExploitDB raw doc to Silver.
        """
        if not doc.get("id"):
            return None
            
        # Helper for int casting
        def to_int(val):
            try: return int(val)
            except: return None
        
        # Helper for simple date validation/parsing if needed
        def parse_date(d):
            # Bronze should have ISO YYYY-MM-DD. 
            # We return as is or object? User wants date_published (Partition Key).
            # BaseSilver checks string > string is fine for YYYY-MM-DD.
            return d

        silver = {
            "_id": doc.get("id"),
            "id": doc.get("id"),
            "file": doc.get("file"),
            "description": doc.get("description"),
            "date_published": parse_date(doc.get("date_published")),
            "author": doc.get("author"),
            "type": doc.get("type"),
            "platform": doc.get("platform"),
            "platform": doc.get("platform"),
            "port": to_int(doc.get("port")),
            "screenshot_url": doc.get("screenshot_url"),
            "verified": doc.get("verified"),
            
            # Remaining fields (Likely still None unless scraped in future update)
            "date_added": doc.get("date_added"),
            "date_updated": doc.get("date_updated"),
            "codes": doc.get("codes"),
            "tags": doc.get("tags"),
            "aliases": doc.get("aliases"),
            "application_url": doc.get("application_url"),
            "source_url": doc.get("source_url")
        }
        return silver
