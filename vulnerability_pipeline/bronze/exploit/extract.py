import requests
import csv
from datetime import datetime
from vulnerability_pipeline.core.base_etl import BaseExtractor

class ExploitDBExtractor(BaseExtractor):
    def __init__(self):
        super().__init__("ExploitDB")
        self.url = "https://gitlab.com/exploit-database/exploitdb/-/raw/main/files_exploits.csv"

    def extract(self, since=None):
        try:
            print("Fetching ExploitDB data...")
            response = requests.get(self.url, timeout=30)
            response.raise_for_status()
            
            content = response.content.decode('utf-8')
            reader = csv.DictReader(content.splitlines())
            
            # Note: The user mentioned 'date_updated', but standard ExploitDB CSV has 'date_published'.
            # We will use 'date_published' as the incremental key unless 'date_updated' is found.
            
            count = 0 
            for row in reader:
                # Incremental check
                if since:
                    # date_published is typically YYYY-MM-DD
                    date_val = row.get("date_updated") or row.get("date_published")
                    if date_val and date_val <= since:
                        continue
                
                yield row
                count += 1
            
            print(f"Yielded {count} ExploitDB records.")
                
        except Exception as e:
            print(f"Error extracting ExploitDB data: {e}")
            return []
