from .extract import NVDExtractor
from .load import NVDLoader
from ....core.config import Config

def run_nvd_pipeline():
    print("Starting NVD Pipeline...")
    # Initialize extractor with API key from config
    extractor = NVDExtractor(api_key=Config.NVD_API_KEY)
    loader = NVDLoader()
    
    print(f"Using API Key: {'Yes' if Config.NVD_API_KEY else 'No'}")
    
    # Fetch all data concurrently and load incrementally
    # Adjust max_workers based on API key presence to be safe/aggressive
    workers = 10 if Config.NVD_API_KEY else 2
    
    total_loaded = 0
    for batch in extractor.extract_all_concurrent(batch_size=2000, max_workers=workers):
        if batch:
            loader.load_bulk(batch)
            total_loaded += len(batch)
            print(f"Total processed so far: {total_loaded}")
            
    if total_loaded == 0:
        print("No data extracted.")
    else:
        print(f"Grand Total records loaded: {total_loaded}")

    print("NVD Pipeline Completed.")

if __name__ == "__main__":
    run_nvd_pipeline()
