import requests
from datetime import datetime
from vulnerability_pipeline.core.base_etl import BaseExtractor

class CISAExtractor(BaseExtractor):
    def __init__(self):
        super().__init__("CISA")
        self.url = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"

    def extract(self, since=None):
        try:
            print("Fetching CISA data...")
            response = requests.get(self.url, timeout=30)
            response.raise_for_status()
            data = response.json()
            
            catalog_version = data.get("catalogVersion")
            date_released = data.get("dateReleased")
            count = data.get("count")
            vulnerabilities = data.get("vulnerabilities", [])
            
            print(f"Total CISA records found: {len(vulnerabilities)}")
            
            for vuln in vulnerabilities:
                # Incremental check: since is expected to be a date string YYYY-MM-DD
                if since:
                    date_added = vuln.get("dateAdded")
                    # Simple string comparison works for YYYY-MM-DD
                    if not date_added or date_added <= since:
                        continue

                # Enrich with catalog metadata
                vuln["catalogVersion"] = catalog_version
                vuln["dateReleased"] = date_released
                vuln["count"] = count
                yield vuln
                
        except Exception as e:
            print(f"Error extracting CISA data: {e}")
            return []
