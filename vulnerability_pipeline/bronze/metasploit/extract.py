import requests
import json
from vulnerability_pipeline.core.base_etl import BaseExtractor

class MetasploitExtractor(BaseExtractor):
    def __init__(self):
        super().__init__("Metasploit")
        self.url = "https://raw.githubusercontent.com/rapid7/metasploit-framework/master/db/modules_metadata_base.json"

    def extract(self, since=None):
        try:
            print("Fetching Metasploit data from GitHub...")
            response = requests.get(self.url, timeout=120)
            response.raise_for_status()
            
            data = response.json()
            # The JSON is a dict: {"exploit/path": {metadata}, ...}
            
            count = 0 
            for fullname, metadata in data.items():
                # Enrich with fullname if missing (usually it's the key)
                metadata['fullname'] = fullname
                
                # Incremental check
                if since:
                    mod_time = metadata.get("mod_time")
                    # data format in JSON is "2023-01-01 12:00:00 +0000" or similar? 
                    # Actually let's just do string compare for now, usually ISO-ish.
                    # Or date-based check. "2017-07-24 13:38:08 +0000"
                    
                    # Simple string compare works if format is YYYY-MM-DD
                    if mod_time and str(mod_time) <= str(since):
                       continue

                yield metadata
                count += 1
            
            print(f"Yielded {count} Metasploit records.")

        except Exception as e:
            print(f"Error extracting Metasploit data: {e}")
