from datetime import datetime
from ....core.mongo_client import MongoManager
from ....core.config import Config

class ExploitDBLoader:
    def __init__(self):
        self.client = MongoManager.get_client()
        self.db = MongoManager.get_bronze_db()
        self.collection = self.db[Config.COLLECTION_EXPLOIT]

    def load(self, data):
        if not data:
            print("No ExploitDB data to load.")
            return

        documents = []
        for row in data:
            # Keys from image: id(PK), file, description, date_published, author, type, platform, port
            # CSV headers: id, file, description, date_published, author, type, platform, port
            
            doc = {
                "id": row.get("id"),
                "file": row.get("file"),
                "description": row.get("description"),
                "date_published": row.get("date_published"),
                "author": row.get("author"),
                "type": row.get("type"),
                "platform": row.get("platform"),
                "port": row.get("port"),
                "ingested_at": datetime.utcnow()
            }
            documents.append(doc)

        if documents:
            try:
                # Upsert based on id
                for doc in documents:
                    self.collection.update_one(
                        {"id": doc["id"]},
                        {"$set": doc},
                        upsert=True
                    )
                print(f"Successfully loaded {len(documents)} ExploitDB records into Bronze.")
            except Exception as e:
                print(f"Error loading ExploitDB data: {e}")
