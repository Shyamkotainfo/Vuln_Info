from datetime import datetime
from ....core.mongo_client import MongoManager
from ....core.config import Config

class MetasploitLoader:
    def __init__(self):
        self.client = MongoManager.get_client()
        self.db = MongoManager.get_bronze_db()
        self.collection = self.db[Config.COLLECTION_METASPLOIT]

    def load(self, data):
        if not data:
            print("No Metasploit data to load.")
            return

        documents = []
        for row in data:
            # Keys from image: title(PK), name, fullname, aliases, rank, disclosure_date, type, platform, port, etc.
            
            doc = {
                "title": row.get("title"),
                "name": row.get("name"),
                "fullname": row.get("fullname"),
                "aliases": row.get("aliases"), # Might need parsing if it's a list string
                "rank": row.get("rank"),
                "disclosure_date": row.get("disclosure_date"),
                "type": row.get("type"),
                "platform": row.get("platform"),
                "arch": row.get("arch"),
                "rport": row.get("rport"),
                "autofilter_ports": row.get("autofilter_ports"),
                "autofilter_services": row.get("autofilter_services"),
                "targets": row.get("targets"),
                "mod_time": row.get("mod_time"),
                "path": row.get("path"),
                "is_install_path": row.get("is_install_path"),
                "ref_name": row.get("ref_name"),
                "check": row.get("check"),
                "post_auth": row.get("post_auth"),
                "default_credential": row.get("default_credential"),
                "notes": row.get("notes"),
                "session_types": row.get("session_types"),
                "needs_cleanup": row.get("needs_cleanup"),
                "actions": row.get("actions"),
                "author": row.get("author"), 
                "description": row.get("description"),
                "references": row.get("references"),
                "ingested_at": datetime.utcnow()
            }
            documents.append(doc)

        if documents:
            try:
                # Upsert based on title or fullname
                for doc in documents:
                    if doc.get("fullname"):
                         self.collection.update_one(
                            {"fullname": doc["fullname"]},
                            {"$set": doc},
                            upsert=True
                        )
                print(f"Successfully loaded {len(documents)} Metasploit records into Bronze.")
            except Exception as e:
                print(f"Error loading Metasploit data: {e}")
