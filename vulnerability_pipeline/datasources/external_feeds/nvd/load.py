from datetime import datetime
from ....core.mongo_client import MongoManager
from ....core.config import Config

class NVDLoader:
    def __init__(self):
        self.client = MongoManager.get_client()
        self.db = MongoManager.get_bronze_db()
        self.collection = self.db[Config.COLLECTION_NVD]

    def load(self, data):
        if not data:
            print("No NVD data to load.")
            return

        documents = []
        for item in data:
            # Flatten or keep structure based on user's image keys
            # Image shows: id, sourceIdentifier, published, lastModified, vulnStatus, etc.
            # The API 'cve' object maps to these.
            cve_item = item.get('cve', {})
            
            doc = {
                "id": cve_item.get("id"),
                "sourceIdentifier": cve_item.get("sourceIdentifier"),
                "published": cve_item.get("published"),
                "lastModified": cve_item.get("lastModified"),
                "vulnStatus": cve_item.get("vulnStatus"),
                "cveTags": cve_item.get("cveTags"),
                "descriptions": cve_item.get("descriptions"),
                "metrics": cve_item.get("metrics"),
                "weaknesses": cve_item.get("weaknesses"),
                "configurations": cve_item.get("configurations"),
                "references": cve_item.get("references"),
                "ingested_at": datetime.utcnow()
            }
            documents.append(doc)

        if documents:
            try:
                # Upsert based on id
                for doc in documents:
                    self.collection.update_one(
                        {"id": doc["id"]},
                        {"$set": doc},
                        upsert=True
                    )
                print(f"Successfully loaded {len(documents)} NVD records into Bronze.")
            except Exception as e:
                print(f"Error loading NVD data: {e}")
