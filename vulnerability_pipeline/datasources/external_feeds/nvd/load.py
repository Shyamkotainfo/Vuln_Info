from ...base import BaseLoader
from ....core.config import Config

class NVDLoader(BaseLoader):
    def __init__(self):
        super().__init__(Config.COLLECTION_NVD, key_field="id")

    def transform(self, item):
        cve_item = item.get('cve', {})
        if not cve_item:
            return None
            
        doc = {
            "id": cve_item.get("id"),
            "sourceIdentifier": cve_item.get("sourceIdentifier"),
            "published": cve_item.get("published"),
            "lastModified": cve_item.get("lastModified"),
            "vulnStatus": cve_item.get("vulnStatus"),
            "cveTags": cve_item.get("cveTags"),
            "descriptions": cve_item.get("descriptions"),
            "metrics": cve_item.get("metrics"),
            "weaknesses": cve_item.get("weaknesses"),
            "configurations": cve_item.get("configurations"),
            "references": cve_item.get("references"),
            # 'ingested_at' will be added by base load()
        }
        return doc

        documents = []
        for item in data:
            # Flatten or keep structure based on user's image keys
            # Image shows: id, sourceIdentifier, published, lastModified, vulnStatus, etc.
            # The API 'cve' object maps to these.
            cve_item = item.get('cve', {})
            
            doc = {
                "id": cve_item.get("id"),
                "sourceIdentifier": cve_item.get("sourceIdentifier"),
                "published": cve_item.get("published"),
                "lastModified": cve_item.get("lastModified"),
                "vulnStatus": cve_item.get("vulnStatus"),
                "cveTags": cve_item.get("cveTags"),
                "descriptions": cve_item.get("descriptions"),
                "metrics": cve_item.get("metrics"),
                "weaknesses": cve_item.get("weaknesses"),
                "configurations": cve_item.get("configurations"),
                "references": cve_item.get("references"),
                "ingested_at": datetime.utcnow()
            }
            documents.append(doc)

        if documents:
            try:
                # Upsert based on id
                for doc in documents:
                    self.collection.update_one(
                        {"id": doc["id"]},
                        {"$set": doc},
                        upsert=True
                    )
                print(f"Successfully loaded {len(documents)} NVD records into Bronze.")
            except Exception as e:
                print(f"Error loading NVD data: {e}")
