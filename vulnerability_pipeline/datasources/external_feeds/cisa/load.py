from datetime import datetime
from ....core.mongo_client import MongoManager
from ....core.config import Config

class CISALoader:
    def __init__(self):
        self.client = MongoManager.get_client()
        self.db = MongoManager.get_bronze_db()
        self.collection = self.db[Config.COLLECTION_CISA]

    def load(self, data):
        if not data:
            print("No CISA data to load.")
            return

        catalog_version = data.get("catalogVersion")
        date_released = data.get("dateReleased")
        vulnerabilities = data.get("vulnerabilities", [])

        if not vulnerabilities:
            return

        documents = []
        for vuln in vulnerabilities:
            # Fields from image: title, catalogVersion, dateReleased, count, vulnerabilities dict
            # We treat each vulnerability as a document in Bronze, enriching with catalog metadata
            doc = {
                "cveID": vuln.get("cveID"),
                "vendorProject": vuln.get("vendorProject"),
                "product": vuln.get("product"),
                "vulnerabilityName": vuln.get("vulnerabilityName"),
                "dateAdded": vuln.get("dateAdded"),
                "shortDescription": vuln.get("shortDescription"),
                "requiredAction": vuln.get("requiredAction"),
                "dueDate": vuln.get("dueDate"),
                "knownRansomwareCampaignUse": vuln.get("knownRansomwareCampaignUse"),
                "notes": vuln.get("notes"),
                "catalogVersion": catalog_version,
                "dateReleased": date_released,
                "ingested_at": datetime.utcnow()
            }
            documents.append(doc)

        if documents:
            try:
                # Upsert based on cveID
                for doc in documents:
                    self.collection.update_one(
                        {"cveID": doc["cveID"]},
                        {"$set": doc},
                        upsert=True
                    )
                print(f"Successfully loaded {len(documents)} CISA records into Bronze.")
            except Exception as e:
                print(f"Error loading CISA data: {e}")
