from datetime import datetime
from ....core.mongo_client import MongoManager
from ....core.config import Config

class EPSSLoader:
    def __init__(self):
        self.client = MongoManager.get_client()
        self.db = MongoManager.get_bronze_db()
        self.collection = self.db[Config.COLLECTION_EPSS]

    def load(self, data):
        if not data:
            print("No EPSS data to load.")
            return

        documents = []
        for row in data:
            # Keys from image: cve (PK), epss, percentile, date (partition key)
            # The CSV usually has 'cve', 'epss', 'percentile'
            
            doc = {
                "cve": row.get("cve"),
                "epss": float(row.get("epss", 0)),
                "percentile": float(row.get("percentile", 0)),
                "date": row.get("date", datetime.utcnow().strftime("%Y-%m-%d")), # Often in the header or filename, but we'll use current if not present
                "ingested_at": datetime.utcnow()
            }
            documents.append(doc)

        if documents:
            try:
                # Upsert based on cve (and maybe date if historical)
                # For now, keeping latest per CVE as per typical usage, or simple upsert
                for doc in documents:
                    self.collection.update_one(
                        {"cve": doc["cve"]},
                        {"$set": doc},
                        upsert=True
                    )
                print(f"Successfully loaded {len(documents)} EPSS records into Bronze.")
            except Exception as e:
                print(f"Error loading EPSS data: {e}")
