import requests
import csv
import gzip
from datetime import datetime
from ...base import BaseExtractor

class EPSSExtractor(BaseExtractor):
    def __init__(self):
        super().__init__("EPSS")
        self.url = "https://epss.cyentia.com/epss_scores-current.csv.gz"

    def extract(self, since=None):
        try:
            print("Fetching EPSS data...")
            response = requests.get(self.url, timeout=60, stream=True)
            response.raise_for_status()
            
            # Since EPSS is a single file snapshot, "incremental" based on rows isn't easy without date in file.
            # However, the file typically has a comment #model_version:v2023.03.01, #score_date:2024-12-09
            # checking the date in comment is best way to see if we need to process it.
            
            # Decompress on the fly
            with gzip.open(response.raw, mode='rt', encoding='utf-8') as f:
                # Read metadata lines
                score_date = None
                lines_iterator = iter(f)
                
                # We need to peek/consume lines to find metadata and header
                # Since we can't easily peek generator, we will iterate.
                
                # Usually first line is model version, second is score date
                # We will read until we hit header (not starting with #)
                
                header_found = False
                fieldnames = None
                
                # We handle the iteration manually to capture metadata
                # Then yield dicts
                
                # Strategy: collect lines until header
                meta_lines = []
                # Reconstruct a generator? 
                
                # Simpler: just read line by line.
                
                for line in lines_iterator:
                    if line.startswith('#'):
                        if "score_date" in line:
                            parts = line.split(':')
                            if len(parts) > 1:
                                score_date = parts[1].strip()
                        continue
                    else:
                        # This is the header line
                        fieldnames = line.strip().split(',')
                        break
                
                # Now we have score_date. Logical check:
                if since and score_date:
                    if score_date <= since:
                        print(f"Skipping EPSS load. Score date {score_date} <= since {since}")
                        return

                if not fieldnames:
                    print("EPSS header not found.")
                    return

                print(f"Processing EPSS for date: {score_date}")
                
                reader = csv.DictReader(lines_iterator, fieldnames=fieldnames)
                for row in reader:
                    # Enrich with date here
                    row['date'] = score_date if score_date else datetime.utcnow().strftime("%Y-%m-%d")
                    yield row
                    
        except Exception as e:
            print(f"Error extracting EPSS data: {e}")
            return []
